<?= $this->extend('layouts/sidebar') ?>
<?= $this->section('mainContent') ?>
<br><br>
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="page-title">Report Details</h2>
        </div>
        <div class="col-auto">
            <a href="/report" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i> Back
            </a>
        </div>
    </div>
</div>
<br>
    <?php if(!empty($rep)): ?>
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0 text-dark fw-bold">Report Information</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-vcenter card-table mb-0">
                    <tbody>
                        <tr>
                            <td style="width: 25%;"><strong class="text-dark">Report ID</strong></td>
                            <td><span class="badge bg-blue">#<?= esc($rep['report_id']) ?></span></td>
                        </tr>
                        <tr>
                            <td><strong class="text-dark">Report Type</strong></td>
                            <td><span class="badge bg-primary text-white"><?= esc(ucfirst(str_replace('_', ' ', $rep['report_type']))) ?></span></td>
                        </tr>
                        <tr>
                            <td><strong class="text-dark">Generated By</strong></td>
                            <td><?= esc($rep['generated_by']) ?></td>
                        </tr>
                        <tr>
                            <td><strong class="text-dark">Generated Date</strong></td>
                            <td><?= esc($rep['generated_at']) ?></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <?php 
        $report_type = strtolower(trim($rep['report_type']));
        // If stored report_type is blank, show a chooser to let the user select which report type to render.
        // Ensure all expected keys exist with defaults
        $report_data = array_merge([
            'patients' => [],
            'consultations' => [],
            'appointments' => [],
            'inventory' => [],
            'announcements' => [],
            'pending' => [],
            'approved' => [],
            'completed' => [],
            'low_stock' => [],
            'summary' => [],
            'total_patients' => 0,
            'total_consultations' => 0,
            'total_appointments' => 0,
            'total_items' => 0,
            'total_announcements' => 0,
        ], $report_data ?? []);
        ?>

        <?php if(empty($report_type)): ?>
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fa-solid fa-circle-info"></i> This report was created before report types were required. Choose which report type you want this record to represent.
                    </div>
                    <form action="<?= base_url('/report/set_report_type/'.$rep['report_id']) ?>" method="post" class="row">
                        <?= csrf_field() ?>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Report Type <span class="text-danger">*</span></label>
                            <select name="report_type" class="form-select" required>
                                <option value="">-- Select --</option>
                                <option value="patient">Patient</option>
                                <option value="consultation">Consultation</option>
                                <option value="appointment">Appointment</option>
                                <option value="inventory">Inventory</option>
                                <option value="announcement">Announcement</option>
                                <option value="comprehensive">Comprehensive (All Data)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fa-solid fa-check"></i> Set and View
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        <?php elseif(!empty($report_data)): ?>

            <?php if($report_type === 'patient'): ?>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-1">Patient Report</h5>
                        <p class="text-dark mb-0">Total Patients: <strong><?= $report_data['total_patients'] ?? 0 ?></strong></p>
                    </div>
                    <?php if(!empty($report_data['patients'])): ?>
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Full Name</th>
                                    <th>Gender</th>
                                    <th>Blood Type</th>
                                    <th>Contact</th>
                                    <th>Date Added</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['patients'] as $p): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($p['patient_id']) ?></span></td>
                                    <td><?= esc($p['last_name']) . ', ' . esc($p['first_name']) . ' ' . esc($p['middle_name']) ?></td>
                                    <td><?= esc(ucfirst($p['gender'])) ?></td>
                                    <td><span class="badge bg-danger"><?= esc($p['blood_type'] ?: 'N/A') ?></span></td>
                                    <td><?= esc($p['contact_no'] ?: 'N/A') ?></td>
                                    <td><?= esc($p['created_at']) ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                    <?php else: ?>
                    <div class="card-body">
                        <div class="empty">
                            <p class="empty-title">No patients found</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <?php if($report_type === 'consultation'): ?>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-1">Consultation Report</h5>
                        <p class="text-dark mb-0">Total Consultations: <strong><?= $report_data['total_consultations'] ?? 0 ?></strong></p>
                    </div>
                    <?php if(!empty($report_data['consultations'])): ?>
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Consultation ID</th>
                                    <th>Patient ID</th>
                                    <th>Diagnosis</th>
                                    <th>Treatment</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['consultations'] as $c): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($c['consultation_id']) ?></span></td>
                                    <td><?= esc($c['patient_id']) ?></td>
                                    <td><?= esc($c['diagnosis']) ?></td>
                                    <td><?= esc($c['treatment'] ?: 'N/A') ?></td>
                                    <td><?= esc($c['consultation_date']) ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                    <?php else: ?>
                    <div class="card-body">
                        <div class="empty">
                            <p class="empty-title">No consultations found</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <?php if($report_type === 'appointment'): ?>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-1">Appointment Report</h5>
                        <p class="text-dark mb-0">
                            Total: <strong><?= esc($report_data['total_appointments'] ?? 0) ?></strong> | 
                            <span class="badge bg-warning">Pending: <?= esc(count($report_data['pending'] ?? [])) ?></span>
                            <span class="badge bg-info">Approved: <?= esc(count($report_data['approved'] ?? [])) ?></span>
                            <span class="badge bg-success">Completed: <?= esc(count($report_data['completed'] ?? [])) ?></span>
                        </p>
                    </div>
                    <?php if(!empty($report_data['appointments'])): ?>
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Appointment ID</th>
                                    <th>Patient ID</th>
                                    <th>Date</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['appointments'] as $a): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($a['appointment_id']) ?></span></td>
                                    <td><?= esc($a['patient_id']) ?></td>
                                    <td><?= esc($a['appointment_date']) ?></td>
                                    <td><?= esc($a['purpose'] ?: 'N/A') ?></td>
                                    <td>
                                        <?php 
                                            $status_color = match($a['status']) {
                                                'pending' => 'warning',
                                                'approved' => 'info',
                                                'completed' => 'success',
                                                'cancelled' => 'danger',
                                                default => 'secondary'
                                            };
                                        ?>
                                        <span class="badge bg-<?= $status_color ?>"><?= esc(ucfirst($a['status'])) ?></span>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                    <?php else: ?>
                    <div class="card-body">
                        <div class="empty">
                            <p class="empty-title">No appointments found</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <?php if($report_type === 'inventory'): ?>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-1">Inventory Report</h5>
                        <p class="text-dark mb-0">
                            Total Items: <strong><?= $report_data['total_items'] ?></strong> | 
                            <span class="badge bg-danger">Low Stock (<5): <?= count($report_data['low_stock'] ?? []) ?></span>
                        </p>
                    </div>
                    <?php if(!empty($report_data['inventory'])): ?>
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Expiry Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['inventory'] as $i): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($i['item_id']) ?></span></td>
                                    <td><?= esc($i['item_name']) ?></td>
                                    <td><span class="badge bg-primary text-white"><?= esc(ucfirst($i['category'])) ?></span></td>
                                    <td>
                                        <?php $qty_color = ($i['quantity'] < 5) ? 'danger' : 'success'; ?>
                                        <span class="badge bg-<?= $qty_color ?>"><?= esc($i['quantity']) ?></span>
                                    </td>
                                    <td><?= esc($i['unit'] ?: 'N/A') ?></td>
                                    <td><?= esc($i['expiry_date'] ?: 'N/A') ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                    <?php else: ?>
                    <div class="card-body">
                        <div class="empty">
                            <p class="empty-title">No inventory items found</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <?php if($report_type === 'announcement'): ?>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-1">Announcement Report</h5>
                        <p class="text-dark mb-0">Total Announcements: <strong><?= esc($report_data['total_announcements']) ?></strong></p>
                    </div>
                    <?php if(!empty($report_data['announcements'])): ?>
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Announcement ID</th>
                                    <th>Title</th>
                                    <th>Posted By</th>
                                    <th>Posted Date</th>
                                    <th>Posted Until</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['announcements'] as $an): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($an['announcement_id']) ?></span></td>
                                    <td><?= esc($an['title']) ?></td>
                                    <td><?= esc($an['posted_by']) ?></td>
                                    <td><?= esc($an['posted_at']) ?></td>
                                    <td><?= esc($an['posted_until']) ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                    <?php else: ?>
                    <div class="card-body">
                        <div class="empty">
                            <p class="empty-title">No announcements found</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <?php if($report_type === 'comprehensive'): ?>
                <h3 class="mb-3">Comprehensive Report Summary</h3>
                <div class="row mb-3">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-dark text-uppercase mb-2">Total Patients</div>
                                <div class="h3 mb-0"><?= $report_data['summary']['total_patients'] ?? 0 ?></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-dark text-uppercase mb-2">Consultations</div>
                                <div class="h3 mb-0"><?= $report_data['summary']['total_consultations'] ?? 0 ?></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-dark text-uppercase mb-2">Appointments</div>
                                <div class="h3 mb-0"><?= $report_data['summary']['total_appointments'] ?? 0 ?></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-dark text-uppercase mb-2">Inventory Items</div>
                                <div class="h3 mb-0"><?= $report_data['summary']['total_inventory_items'] ?? 0 ?></div>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 class="mt-4 mb-2">Patients</h4>
                <?php if(!empty($report_data['patients'])): ?>
                <div class="card mb-3">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Full Name</th>
                                    <th>Gender</th>
                                    <th>Contact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['patients'] as $p): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($p['patient_id']) ?></span></td>
                                    <td><?= esc($p['last_name']) . ', ' . esc($p['first_name']) ?></td>
                                    <td><?= esc(ucfirst($p['gender'])) ?></td>
                                    <td><?= esc($p['contact_no'] ?: 'N/A') ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php else: ?>
                <p class="text-dark">No patients found</p>
                <?php endif; ?>

                <h4 class="mt-4 mb-2">Consultations</h4>
                <?php if(!empty($report_data['consultations'])): ?>
                <div class="card mb-3">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Consultation ID</th>
                                    <th>Appointment ID</th>
                                    <th>Patient ID</th>
                                    <th>Diagnosis</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['consultations'] as $c): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($c['consultation_id']) ?></span></td>
                                    <td><?= esc($c['appointment_id'] ?? 'N/A') ?></td>
                                    <td><?= esc($c['patient_id']) ?></td>
                                    <td><?= esc($c['diagnosis']) ?></td>
                                    <td><?= esc($c['consultation_date']) ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php else: ?>
                <p class="text-dark">No consultations found</p>
                <?php endif; ?>

                <h4 class="mt-4 mb-2">Appointments</h4>
                <?php if(!empty($report_data['appointments'])): ?>
                <div class="card mb-3">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Appointment ID</th>
                                    <th>Patient ID</th>
                                    <th>Date</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['appointments'] as $a): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($a['appointment_id']) ?></span></td>
                                    <td><?= esc($a['patient_id']) ?></td>
                                    <td><?= esc($a['appointment_date']) ?></td>
                                    <td><?= esc($a['purpose'] ?: 'N/A') ?></td>
                                    <td>
                                        <?php 
                                            $status_color = match($a['status']) {
                                                'pending' => 'warning',
                                                'approved' => 'info',
                                                'completed' => 'success',
                                                'cancelled' => 'danger',
                                                default => 'secondary'
                                            };
                                        ?>
                                        <span class="badge bg-<?= $status_color ?>"><?= esc(ucfirst($a['status'])) ?></span>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php else: ?>
                <p class="text-dark">No appointments found</p>
                <?php endif; ?>

                <h4 class="mt-4 mb-2">Inventory</h4>
                <?php if(!empty($report_data['inventory'])): ?>
                <div class="card mb-3">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Expiry Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['inventory'] as $i): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($i['item_id']) ?></span></td>
                                    <td><?= esc($i['item_name']) ?></td>
                                    <td><span class="badge bg-primary text-white"><?= esc(ucfirst($i['category'])) ?></span></td>
                                    <td>
                                        <?php $qty_color = ($i['quantity'] < 5) ? 'danger' : 'success'; ?>
                                        <span class="badge bg-<?= $qty_color ?>"><?= esc($i['quantity']) ?></span>
                                    </td>
                                    <td><?= esc($i['unit'] ?: 'N/A') ?></td>
                                    <td><?= esc($i['expiry_date'] ?: 'N/A') ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php else: ?>
                <p class="text-dark">No inventory items found</p>
                <?php endif; ?>

                <h4 class="mt-4 mb-2">Announcements</h4>
                <?php if(!empty($report_data['announcements'])): ?>
                <div class="card mb-3">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Announcement ID</th>
                                    <th>Title</th>
                                    <th>Posted By</th>
                                    <th>Posted Date</th>
                                    <th>Posted Until</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($report_data['announcements'] as $an): ?>
                                <tr>
                                    <td><span class="badge bg-blue"><?= esc($an['announcement_id']) ?></span></td>
                                    <td><?= esc($an['title']) ?></td>
                                    <td><?= esc($an['posted_by']) ?></td>
                                    <td><?= esc($an['posted_at']) ?></td>
                                    <td><?= esc($an['posted_until']) ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php else: ?>
                <p class="text-dark">No announcements found</p>
                <?php endif; ?>
            <?php endif; ?>

        <?php else: ?>
            <div class="alert alert-info">
                <i class="fa-solid fa-circle-info"></i> No data available for comprehensive report
            </div>
        <?php endif; ?>
        <div class="mt-4 pt-3 border-top">
            <div class="btn-group" role="group">
                <a href="<?= base_url('/report/export/'.$rep['report_id']) ?>" class="btn btn-primary">
                    <i class="fa-solid fa-file-csv"></i> Export CSV
                </a>
                <a href="<?= base_url('/report/export/'.$rep['report_id']) ?>?format=xlsx" class="btn btn-info">
                    <i class="fa-solid fa-file-excel"></i> Export Excel
                </a>
                <a href="<?= base_url('/report/export/'.$rep['report_id']) ?>?format=pdf" class="btn btn-warning">
                    <i class="fa-solid fa-file-pdf"></i> Export PDF
                </a>
                <a href="<?= base_url('/report/delete/'.$rep['report_id']) ?>" class="btn btn-danger" onclick="return confirm('Delete this report?')">
                    <i class="fa-solid fa-trash"></i> Delete Report
                </a>
            </div>
        </div>

    <?php else: ?>
        <div class="alert alert-warning">
            <i class="fa-solid fa-circle-exclamation"></i> Report not found
        </div>
        <a href="/report" class="btn btn-secondary">Back to Reports</a>
    <?php endif; ?>

<?= $this->endSection() ?>
